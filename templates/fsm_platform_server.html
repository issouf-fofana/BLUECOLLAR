{% load static %}
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Call Center Work Order System</title>
<link rel="icon" href="{% static 'favicon.ico' %}">
<link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#f6f8fb; --panel:#ffffff; --soft:#f9fbff; --line:#e6eaf2;
  --text:#0f172a; --muted:#5b677a;
  --brand:#1f59d8; --brand2:#0ea5e9; --accent:#7c3aed;
  --ok:#10b981; --warn:#f59e0b; --err:#ef4444;
  --ring:0 0 0 3px rgba(31,89,216,.25);
  --shadow:0 20px 60px rgba(2,6,23,.06)
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:linear-gradient(180deg,var(--bg),var(--bg));color:var(--text);font:14px/1.45 Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}

/* Layout */
.app{display:grid;grid-template-columns:280px 1fr;min-height:100vh}
.sidebar{background:linear-gradient(180deg,var(--panel),var(--soft));border-right:1px solid var(--line)}
.brand{display:flex;align-items:center;gap:.75rem;padding:18px 16px;font-weight:800;border-bottom:1px solid var(--line)}
.logo{width:34px;height:34px;border-radius:10px;background:
  linear-gradient(145deg,#0ea5e9,#1f59d8); display:grid;place-items:center;box-shadow:0 8px 22px rgba(2,6,23,.12)}
.logo svg{width:22px;height:22px;fill:#fff;opacity:.9}
.brandname{letter-spacing:.02em}
.nav{padding:12px}
.nav h4{color:#9aa5b5;font-size:12px;letter-spacing:.12em;text-transform:uppercase;margin:16px 12px 8px}
.link{display:flex;align-items:center;gap:.6rem;padding:12px 14px;border-radius:12px;color:#334155;text-decoration:none;border:1px solid transparent;transition:transform .15s,box-shadow .15s}
.link:hover{background:color-mix(in lab,var(--brand) 7%, transparent);border-color:#c5d2f7;transform:translateY(-1px);box-shadow:0 10px 24px rgba(2,6,23,.06)}
.link.active{background:linear-gradient(180deg,#eef4ff,#eaf2ff);border-color:#c5d2f7;color:#0f172a;box-shadow:0 10px 24px rgba(2,6,23,.08)}
.icon{width:18px;height:18px;stroke:currentColor;stroke-width:1.7;fill:none}

.content{background:transparent}
.topbar{display:flex;justify-content:space-between;align-items:center;padding:16px 24px;border-bottom:1px solid var(--line);backdrop-filter: blur(8px)}
.badges{display:flex;gap:8px;flex-wrap:wrap}
.badge{font-size:12px;background:#eef2ff;border:1px solid #dbe3ff;color:#374151;padding:6px 10px;border-radius:999px;display:flex;align-items:center;gap:6px}
.logout{background:#fff;border:1px solid #cbd5e1;color:#334155;border-radius:12px;padding:10px 14px;cursor:pointer;transition:transform .15s}
.logout:hover{transform:translateY(-1px)}

.page{padding:24px}
.hero{background:linear-gradient(90deg,#eef6ff,#f2fbff);border:1px solid #dbeafe;padding:16px 18px;border-radius:14px;color:#1f2937;display:flex;align-items:center;gap:10px}
.h1{font-size:36px;margin:8px 0 6px;font-weight:800;color:#101828}
.sub{color:#6b7280;margin:0 0 22px}

/* Tabs + panel */
.tabs{display:flex;gap:10px;margin:18px 0 0;border-bottom:1px solid #dde6ff;flex-wrap:wrap}
.tab{padding:12px 16px;border:1px solid #dbeafe;border-bottom:none;border-radius:12px 12px 0 0;background:#f0f6ff;color:#1f2937;cursor:pointer;transition:transform .15s}
.tab:hover{transform:translateY(-1px)}
.tab.active{background:#fff;border-color:#c5d2f7}
.panel{background:var(--panel);border:1px solid var(--line);border-top:none;border-radius:0 12px 12px 12px;padding:26px;box-shadow:var(--shadow)}

/* Search card */
.search-card{border:1px solid #dbeafe;background:linear-gradient(180deg,#fbfdff,#ffffff);border-radius:16px;padding:16px}
.search-bar{display:flex;gap:10px;align-items:center}
.search-bar input{
  flex:1;padding:12px 14px;border-radius:12px;border:1px solid var(--line);
  background:#fff;outline:none;transition:box-shadow .2s,border-color .2s
}
.search-bar input:focus{box-shadow:var(--ring);border-color:#8ab4ff}
.meta{display:flex;gap:10px;align-items:center;color:#61718b;font-size:12px;margin-top:8px}
.pill{border:1px solid #cfe0ff;background:#f5f9ff;color:#365188;border-radius:999px;padding:4px 8px}

/* Form */
.grid{display:grid;grid-template-columns:1fr 1fr;gap:18px}
label{display:block;margin:8px 0 6px;color:#334155;font-size:13px;font-weight:600}
input,select,textarea{
  width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--line);
  background:#fff;color:#0b1220;outline:none;transition:box-shadow .2s,border-color .2s,transform .06s ease
}
input:focus,select:focus,textarea:focus{box-shadow:var(--ring);border-color:#2b6cb0; transform: translateY(-1px)}
textarea{min-height:120px;resize:vertical}
.full{grid-column:1 / -1}

/* Stepper */
.stepper{display:flex;gap:10px;align-items:center;margin:10px 0 18px}
.step{display:flex;align-items:center;gap:8px}
.dot{width:24px;height:24px;border-radius:999px;border:2px solid #cfe0ff;display:grid;place-items:center;color:#6b7280;font-weight:700;background:#fff}
.step.active .dot{border-color:var(--brand);color:var(--brand)}
.step.done .dot{background:var(--brand);color:#fff;border-color:var(--brand)}
.step-label{font-size:12px;color:#6b7280}
.step.active .step-label{color:#334155;font-weight:700}
.sep{flex:1;height:2px;background:linear-gradient(90deg,#d9e6ff,#f0f6ff);border-radius:2px}

/* Actions */
.actions{display:flex;gap:12px;justify-content:flex-end;margin-top:16px}
.btn{border:0;border-radius:12px;padding:12px 18px;font-weight:700;cursor:pointer;transition:transform .15s,box-shadow .15s}
.btn:hover{transform:translateY(-1px)}
.btn.primary{background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;box-shadow:0 10px 24px rgba(34,211,238,.28)}
.btn.ghost{background:#fff;border:1px solid #cbd5e1;color:#334155}
.btn.flat{background:#eef4ff;border:1px solid #cfe0ff;color:#1f3a76}
.btn[disabled]{opacity:.6;cursor:not-allowed}

/* Results list */
.reslist{margin-top:12px;border-top:1px dashed #e5e7eb}
.item{display:flex;justify-content:space-between;gap:10px;padding:12px 0;border-bottom:1px dashed #e5e7eb}
.muted{color:#6b7280;font-size:12px}
.err{color:#b91c1c}

/* Loader overlay */
.overlay{position:fixed;inset:0;background:rgba(2,6,23,.35);backdrop-filter:blur(2px);display:none;place-items:center;z-index:80}
.overlay.show{display:grid}
.spinner{width:74px;height:74px;border-radius:999px;border:4px solid rgba(31,89,216,.25);border-top-color:#1f59d8;border-right-color:#0ea5e9;animation:spin 1s linear infinite;position:relative}
.spinner:after{content:"";position:absolute;inset:9px;border-radius:999px;border:3px solid rgba(14,165,233,.25);border-left-color:#0ea5e9;animation:spin 1.4s linear infinite reverse}
@keyframes spin{to{transform:rotate(360deg)}}

/* Modal (shared) */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:18px;background:rgba(2,6,23,.45);backdrop-filter: blur(4px);z-index:90}
.modal.show{display:flex;animation:fade .2s ease both}
@keyframes fade{from{opacity:0}to{opacity:1}}
.modal-card{width:min(780px,92vw);background:#fff;border:1px solid #e5e7eb;border-radius:16px;box-shadow:0 30px 80px rgba(2,6,23,.25);overflow:hidden}
.modal-head{padding:16px 18px;background:linear-gradient(135deg,var(--brand),var(--brand2));color:#fff;display:flex;justify-content:space-between;align-items:center}
.modal-title{margin:0;font-size:18px;font-weight:800}
.badge{font-size:12px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.2);border:1px solid rgba(255,255,255,.35)}
.badge.ok{background:rgba(16,185,129,.2);border-color:rgba(16,185,129,.5)}
.badge.warn{background:rgba(245,158,11,.2);border-color:rgba(245,158,11,.5)}
.modal-body{padding:18px}
.kv{display:grid;grid-template-columns:180px 1fr;gap:8px;margin:8px 0}
.kv code{background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:4px 6px;display:inline-block}
.copy{margin-left:8px;border:1px solid #cbd5e1;border-radius:8px;background:#fff;padding:4px 8px;cursor:pointer}
.linklist a{display:inline-flex;align-items:center;gap:8px;margin:8px 10px 0 0;color:#1f59d8;text-decoration:none;border:1px solid #cfe0ff;padding:8px 12px;border-radius:12px}
.modal-actions{display:flex;gap:10px;justify-content:flex-end;padding:14px 18px;border-top:1px solid #e5e7eb;background:#f8fafc}

/* ===== Customers Directory ===== */
.dir-wrap{display:grid;grid-template-columns:360px 1fr;gap:18px}
.dir-pane{border:1px solid #e6eefc;border-radius:14px;background:#fff}
.dir-pane.head{padding:14px 16px;border-bottom:1px solid #e6eefc;background:linear-gradient(180deg,#f6faff,#ffffff);border-radius:14px 14px 0 0}
.dir-list{max-height:560px;overflow:auto}
.dir-item{display:flex;gap:10px;align-items:flex-start;padding:12px 14px;border-top:1px dashed #eef2ff;cursor:pointer}
.dir-item:hover{background:#f7fbff}
.dir-item.active{background:#eef6ff}
.dir-title{font-weight:700}
.dir-sub{font-size:12px;color:#60708a}
.detail{padding:16px}
.detail h3{margin:0 0 6px;font-size:20px}
.block{border:1px dashed #e5e7eb;border-radius:12px;padding:12px;margin:10px 0;background:#fafcff}
.klist{margin:0;padding-left:18px}
</style>
</head>
<body>

<section class="app">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="brand">
      <div class="logo">
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2l2.1 4.5 4.9-.6-3.2 3.6L18.8 14l-4.7-1.7L12 18l-2.1-5.7L5.2 14l3-4.5L5.3 5.9l4.9.6L12 2z"/></svg>
      </div>
      <div class="brandname">BlueCollar</div>
    </div>
    <nav class="nav">
      <h4>Core Modules</h4>
      <a class="link" href="#" id="navFsm">
        <svg class="icon" viewBox="0 0 24 24"><path d="M3 7h18M5 7v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7"/><path d="M8 7V5a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
        Field Service Management
      </a>
      <a class="link" href="#" id="navIntegration">
        <svg class="icon" viewBox="0 0 24 24"><path d="M10 13a5 5 0 0 0 7.07 0l2.83-2.83a5 5 0 0 0-7.07-7.07L11 4"/><path d="M14 11a5 5 0 0 0-7.07 0L4.1 13.83a5 5 0 0 0 7.07 7.07L13 20"/></svg>
        Work Order Integration
      </a>
      <a class="link" href="#" id="navWarranty">
        <svg class="icon" viewBox="0 0 24 24"><path d="M7 3h10a2 2 0 0 1 2 2v16l-3-2-3 2-3-2-3 2V5a2 2 0 0 1 2-2Z"/><path d="M8 10h8M8 14h8M8 6h8"/></svg>
        Warranty Processing
      </a>
      <a class="link active" href="#" id="navAnswering">
        <svg class="icon" viewBox="0 0 24 24"><path d="M3 12a9 9 0 1 1 18 0"/><path d="M7 12v5a3 3 0 0 0 3 3h1"/><path d="M17 12v1a2 2 0 0 1-2 2h-1"/><path d="M7 12H5a2 2 0 0 0-2 2v1a2 2 0 0 0 2 2h2"/></svg>
        Answering Service Agent
      </a>

      <h4>System Management</h4>
      <a class="link" href="#" id="navStatus">
        <svg class="icon" viewBox="0 0 24 24"><path d="M3 3v18h18"/><path d="M7 13v5"/><path d="M12 9v9"/><path d="M17 5v13"/></svg>
        System Status
        <span style="margin-left:auto;background:#103a28;border:1px solid #1d6b4e;color:#67e8f9;padding:2px 8px;border-radius:999px;font-size:12px">5</span>
      </a>
    </nav>
  </aside>

  <!-- MAIN -->
  <main class="content">
    <div class="topbar">
      <div class="badges">
        <div class="badge">
          <svg class="icon" viewBox="0 0 24 24"><path d="M4 7h16v10a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2Z"/><path d="M16 7v-1a3 3 0 0 0-3-3h-2a3 3 0 0 0-3 3v1"/></svg>
          Call Center Agent
        </div>
        <div class="badge">Operator ID: OP-A7B3C9</div>
        <div class="badge">Session: SS-892341</div>
        <div class="badge">Date: <span id="today"></span></div>
      </div>
      <button class="logout" id="logoutBtn">
        <svg class="icon" viewBox="0 0 24 24" style="margin-right:6px"><path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/><path d="M10 17l5-5-5-5"/><path d="M15 12H3"/></svg>
        Logout
      </button>
    </div>

    <div class="page">
      <h1 class="h1">Call Center Work Order System</h1>
      <p class="sub">Streamlined work order submission for client service requests</p>

      <div class="hero" style="margin-bottom:12px">
        <svg class="icon" viewBox="0 0 24 24"><path d="M3 18v-6a2 2 0 0 1 2-2h4l3-3h9v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2Z"/></svg>
        Create jobs for existing customers or add new ones
      </div>

      <div class="tabs">
        <button class="tab active" id="tabExisting">Create Job (Existing Customer)</button>
        <button class="tab" id="tabNew">Create New Customer</button>
        <button class="tab" id="tabDirectory">Customers Directory</button>
      </div>

      <!-- EXISTING CUSTOMER PANEL -->
      <section class="panel" id="panelExisting">
        <h2 class="h1" style="font-size:28px">Create Job for Existing Customer</h2>
        <p class="sub">Quick job creation for established customers</p>

        <!-- Search card -->
        <div class="search-card">
          <div class="search-bar">
            <input id="q" placeholder="Search by customer name, unit or city (e.g., Carolyn Williams, 360 Pie, Plano)">
            <button class="btn flat" id="btnSearch">Search</button>
          </div>
          <div class="meta">
            <span class="pill">Directory • Service Fusion</span>
            <span class="pill" id="countPill" style="display:none">0 results</span>
          </div>
          <div id="searchErr" class="err" style="display:none;margin-top:6px"></div>
          <div id="resultsBox" style="display:none">
            <div class="reslist"><ul id="results" style="list-style:none;margin:0;padding:0"></ul></div>
          </div>
        </div>

        <hr style="border:none;border-top:1px solid var(--line);margin:18px 0">

        <!-- Stepper -->
        <div class="stepper" id="jobStepper">
          <div class="step active" data-step="1"><div class="dot">1</div><div class="step-label">Customer & Location</div></div>
          <div class="sep"></div>
          <div class="step" data-step="2"><div class="dot">2</div><div class="step-label">Job Category & Priority</div></div>
          <div class="sep"></div>
          <div class="step" data-step="3"><div class="dot">3</div><div class="step-label">Contacts</div></div>
          <div class="sep"></div>
          <div class="step" data-step="4"><div class="dot">4</div><div class="step-label">Description & Submit</div></div>
        </div>

        <!-- Job wizard forms (sections) -->
        <form id="jobForm" onsubmit="return false;">
          <!-- S1 -->
          <div class="grid job-step" data-step="1">
            <div class="full"><label>Customer Name *</label><input id="customer_name" required></div>
            <div><label>Existing Customer ID (optional)</label><input id="customer_id" placeholder="e.g., 12345"></div>
            <div><label>Service Location *</label><input id="location_name" required placeholder="Store name / building"></div>

            <div class="full"><label>Street</label><input id="street_1" placeholder="9044 Waterman Dr"></div>
            <div><label>City</label><input id="city" placeholder="Providence Village"></div>
            <div><label>State</label><input id="state" placeholder="Texas"></div>
            <div><label>Zip</label><input id="zip" placeholder="76227"></div>
            <div class="full actions">
              <button class="btn ghost" type="button" disabled>Back</button>
              <button class="btn primary" type="button" data-next="#jobForm">Next</button>
            </div>
          </div>

          <!-- S2 -->
          <div class="grid job-step" data-step="2" style="display:none">
            <div class="full">
              <label>Job Category *</label>
              <select id="category" required>
                <option value="" disabled selected>Select Category</option>
                <option>Refrigeration</option><option>Plumbing</option><option>Electrical</option><option>HVAC</option><option>General Maintenance</option>
              </select>
              <div class="muted" style="margin-top:6px">Will map to Service Fusion’s allowed set automatically.</div>
            </div>
            <div>
              <label>Priority *</label>
              <select id="priority" required>
                <option value="" disabled>Select</option>
                <option>Urgent</option><option selected>Normal</option><option>Low</option>
              </select>
            </div>
            <div class="full">
              <label>Initial Status (optional)</label>
              <select id="status">
                <option value="">(default)</option>
                <option>Unscheduled</option><option>Scheduled</option><option>Dispatched</option>
                <option>On The Way</option><option>On Site</option><option>Started</option>
                <option>Paused</option><option>Resumed</option><option>Partially Completed</option>
                <option>Completed</option><option>Cancelled</option><option>Parts Ordered</option>
                <option>Picking up parts</option><option>Needs Estimate</option><option>Delayed</option>
              </select>
            </div>
            <div class="full actions">
              <button class="btn ghost" type="button" data-back="#jobForm">Back</button>
              <button class="btn primary" type="button" data-next="#jobForm">Next</button>
            </div>
          </div>

          <!-- S3 -->
          <div class="grid job-step" data-step="3" style="display:none">
            <div><label>Contact Name</label><input id="contact_name" placeholder="Jane Doe"></div>
            <div><label>Contact Phone</label><input id="contact_phone" placeholder="+1 555 0100"></div>
            <div><label>Contact Email</label><input id="contact_email" type="email" placeholder="ops@customer.com"></div>
            <div class="full actions">
              <button class="btn ghost" type="button" data-back="#jobForm">Back</button>
              <button class="btn primary" type="button" data-next="#jobForm">Next</button>
            </div>
          </div>

          <!-- S4 -->
          <div class="grid job-step" data-step="4" style="display:none">
            <div class="full"><label>Description *</label><textarea id="description" required placeholder="Describe the issue…"></textarea></div>
            <div class="full actions">
              <button class="btn ghost" type="button" data-back="#jobForm">Back</button>
              <button id="btnCreate" class="btn primary" type="button">Create Job</button>
            </div>
            <div id="formErr" class="err full" style="display:none"></div>
          </div>
        </form>
      </section>

      <!-- NEW CUSTOMER PANEL -->
      <section class="panel" id="panelNew" style="display:none">
        <h2 class="h1" style="font-size:28px">Create New Customer</h2>
        <p class="sub">Onboard a new account, then jump back to create their first job.</p>

        <!-- Stepper -->
        <div class="stepper" id="custStepper">
          <div class="step active" data-step="1"><div class="dot">1</div><div class="step-label">Business & Contact</div></div>
          <div class="sep"></div>
          <div class="step" data-step="2"><div class="dot">2</div><div class="step-label">Primary Location</div></div>
          <div class="sep"></div>
          <div class="step" data-step="3"><div class="dot">3</div><div class="step-label">Review & Create</div></div>
        </div>

        <form id="newCustomerForm" onsubmit="return false;">
          <!-- C1 -->
          <div class="grid cust-step" data-step="1">
            <div class="full"><label>Legal Business Name *</label><input id="nc_name" required placeholder="e.g., Snuffers Restaurant Group"></div>
            <div><label>Primary Contact *</label><input id="nc_contact_name" required placeholder="Jane Doe"></div>
            <div><label>Contact Email *</label><input id="nc_contact_email" required type="email" placeholder="ops@customer.com"></div>
            <div><label>Contact Phone</label><input id="nc_contact_phone" placeholder="+1 555 0100"></div>
            <div class="full actions">
              <button class="btn ghost" type="button" disabled>Back</button>
              <button class="btn primary" type="button" data-next="#newCustomerForm">Next</button>
            </div>
          </div>

          <!-- C2 -->
          <div class="grid cust-step" data-step="2" style="display:none">
            <div class="full"><label>Location Name *</label><input id="loc_name" required placeholder="e.g., Snuffers – Rockwall"></div>
            <div class="full"><label>Street *</label><input id="loc_street" required placeholder="777 S Central Expy"></div>
            <div><label>City *</label><input id="loc_city" required placeholder="Richardson"></div>
            <div><label>State *</label><input id="loc_state" required placeholder="TX"></div>
            <div><label>Zip *</label><input id="loc_zip" required placeholder="75080-7400"></div>
            <div class="full actions">
              <button class="btn ghost" type="button" data-back="#newCustomerForm">Back</button>
              <button class="btn primary" type="button" data-next="#newCustomerForm">Next</button>
            </div>
          </div>

          <!-- C3 -->
          <div class="grid cust-step" data-step="3" style="display:none">
            <div class="full">
              <div class="search-card">
                <div style="font-weight:700;margin-bottom:6px">Review</div>
                <div class="kv"><div>Business Name</div><div id="rev_name">—</div></div>
                <div class="kv"><div>Contact</div><div id="rev_contact">—</div></div>
                <div class="kv"><div>Location</div><div id="rev_loc">—</div></div>
              </div>
            </div>
            <div class="full actions">
              <button class="btn ghost" type="button" data-back="#newCustomerForm">Back</button>
              <button id="btnCreateCustomer" class="btn primary" type="button">Create Customer</button>
            </div>
            <div id="custErr" class="err full" style="display:none"></div>
          </div>
        </form>
      </section>

      <!-- CUSTOMERS DIRECTORY PANEL -->
      <section class="panel" id="panelDirectory" style="display:none">
        <h2 class="h1" style="font-size:28px">Customers Directory</h2>
        <p class="sub">Browse customers, inspect details, and start a job on the selected record.</p>

        <div class="dir-wrap">
          <!-- Left list -->
          <div class="dir-pane">
            <div class="dir-pane head">
              <div class="search-bar">
                <input id="dirQ" placeholder="Type a customer name to filter the list…">
                <button class="btn flat" id="dirSearchBtn">Search</button>
              </div>
              <div class="meta"><span class="pill" id="dirCount">0 results</span></div>
            </div>
            <div class="dir-list" id="dirList" role="listbox" aria-label="Customers list"></div>
          </div>

          <!-- Right detail -->
          <div class="dir-pane">
            <div class="detail" id="dirDetail">
              <h3>Pick a customer</h3>
              <p class="muted">Select a row from the list to see full profile and locations.</p>
              <div class="block">
                <strong>Tip:</strong> after selecting a customer, click “Create Job for this Customer” to pre-fill the job wizard.
              </div>
            </div>
          </div>
        </div>
      </section>

    </div>
  </main>
</section>

<!-- Loader -->
<div id="overlay" class="overlay" aria-hidden="true">
  <div class="spinner" role="status" aria-label="Loading"></div>
</div>

<!-- JOB RESULT MODAL -->
<div id="resultModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="modal-card">
    <div class="modal-head">
      <h3 id="modalTitle" class="modal-title">Job created</h3>
      <span id="emailBadge" class="badge">Email: …</span>
    </div>
    <div class="modal-body">
      <div class="kv"><div>Customer Name</div><div id="kv_customer_name"></div></div>
      <div class="kv"><div>Customer ID</div><div><code id="kv_customer_id">N/A</code><button class="copy" data-copy="#kv_customer_id">Copy</button></div></div>
      <div class="kv"><div>Job ID</div><div><code id="kv_job_id">N/A</code><button class="copy" data-copy="#kv_job_id">Copy</button></div></div>
      <div class="kv"><div>Job Number</div><div><code id="kv_job_number">N/A</code><button class="copy" data-copy="#kv_job_number">Copy</button></div></div>
      <div class="kv"><div>Job API URL</div><div><code id="kv_job_url">N/A</code><button class="copy" data-copy="#kv_job_url">Copy</button></div></div>
      <div class="linklist" id="linkList"></div>
    </div>
    <div class="modal-actions">
      <button id="closeModal" class="btn ghost" type="button">Close</button>
    </div>
  </div>
</div>

<!-- CUSTOMER RESULT MODAL -->
<div id="custModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="custModalTitle">
  <div class="modal-card">
    <div class="modal-head">
      <h3 id="custModalTitle" class="modal-title">Customer created</h3>
      <span class="badge ok">Success</span>
    </div>
    <div class="modal-body">
      <div class="kv"><div>Customer Name</div><div id="cm_customer_name">—</div></div>
      <div class="kv"><div>Customer ID</div>
        <div><code id="cm_customer_id">—</code><button class="copy" data-copy="#cm_customer_id">Copy</button></div>
      </div>
      <div class="kv"><div>Primary Location</div><div id="cm_location">—</div></div>
    </div>
    <div class="modal-actions">
      <button id="custCloseModal" class="btn ghost" type="button">Close</button>
      <button id="custGoToJob" class="btn primary" type="button">Create a Job for this Customer</button>
    </div>
  </div>
</div>

<script>
/* ====== helpers ====== */
const $=(q)=>document.querySelector(q), $$=(q)=>Array.from(document.querySelectorAll(q));
const show=(el,yes=true)=>{el.style.display=yes?'':'none'};
const overlay=$('#overlay');
const startLoading=()=>overlay.classList.add('show');
const endLoading=()=>overlay.classList.remove('show');
$('#today').textContent=new Date().toLocaleDateString();
$('#logoutBtn').onclick = ()=>{ history.back(); };
/* sidebar shortcuts */
$('#navIntegration').onclick = (e)=>{ e.preventDefault(); window.location.href = '{% url "mapping" %}'; };
$('#navFsm').onclick = (e)=>{ e.preventDefault(); window.scrollTo({top:0,behavior:'smooth'}); };
$('#navWarranty').onclick = (e)=>{ e.preventDefault(); alert('Coming soon'); };
$('#navStatus').onclick = (e)=>{ e.preventDefault(); alert('Status: OK'); };

/* ====== Tabs ====== */
const showExisting=()=>{ $('#tabExisting').classList.add('active'); $('#tabNew').classList.remove('active'); $('#tabDirectory').classList.remove('active'); show($('#panelExisting'),true); show($('#panelNew'),false); show($('#panelDirectory'),false); };
const showNew=()=>{ $('#tabNew').classList.add('active'); $('#tabExisting').classList.remove('active'); $('#tabDirectory').classList.remove('active'); show($('#panelExisting'),false); show($('#panelNew'),true); show($('#panelDirectory'),false); };
const showDirectory=()=>{ $('#tabDirectory').classList.add('active'); $('#tabExisting').classList.remove('active'); $('#tabNew').classList.remove('active'); show($('#panelExisting'),false); show($('#panelNew'),false); show($('#panelDirectory'),true); };
$('#tabExisting').onclick=showExisting; $('#tabNew').onclick=showNew; $('#tabDirectory').onclick=showDirectory;

/* ====== Stepper engine (robuste) ====== */
function stepperInit(stepsContainerSel, paneSelector){
  const stepsContainer=$(stepsContainerSel);
  const steps=$$(`${stepsContainerSel} .step`);
  const panes=$$(paneSelector);
  const maxStep = Math.max(steps.length, panes.length);
  function setActive(n){
    const target = Math.min(Math.max(1,n), maxStep);
    steps.forEach((s,i)=>{ s.classList.toggle('active', i===target-1); s.classList.toggle('done', i<target-1); });
    panes.forEach(p=>{ p.style.display = (parseInt(p.getAttribute('data-step'),10)===target)?'grid':'none'; });
  }
  setActive(1);
  // global next/back handlers
  document.addEventListener('click', (e)=>{
    const nextBtn=e.target.closest('[data-next]'); const backBtn=e.target.closest('[data-back]');
    if(nextBtn){
      const currentPane = panes.find(p => p.style.display==='grid') || panes[0];
      const cStep = parseInt(currentPane.getAttribute('data-step'),10) || 1;
      setActive(cStep+1);
    }
    if(backBtn){
      const currentPane = panes.find(p => p.style.display==='grid') || panes[0];
      const cStep = parseInt(currentPane.getAttribute('data-step'),10) || 1;
      setActive(cStep-1);
    }
  });
  return { setActive };
}
// ✅ branchement sur les bons conteneurs
const jobStepper = stepperInit('#jobStepper', '.job-step');
const custStepper = stepperInit('#custStepper', '.cust-step');

/* ====== API wrappers ====== */
const API = {
  search: (q)=> fetch(`/sf/customers/search?q=${encodeURIComponent(q)}`).then(r=>r.json()),
  getCustomer: (id)=> fetch(`/sf/customers/${id}`).then(r=>r.json()),
  createCustomer: (payload)=> fetch(`/sf/customers`, {method:'POST',headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)}).then(async r=>{const j=await r.json().catch(()=>({})); if(!r.ok) throw new Error(j.error||j.message||'Create customer failed'); return j;}),
  createJob: (payload)=> fetch(`/sf/jobs`, {method:'POST',headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)}).then(async r=>{const j=await r.json().catch(()=>({})); if(!r.ok) throw new Error((j.response&&JSON.stringify(j.response))||j.error||j.message||'Create job failed'); return j;})
};

/* ====== Search (existing panel) ====== */
function renderResults(items){
  const box=$('#resultsBox'), ul=$('#results'); ul.innerHTML='';
  const pill=$('#countPill'); pill.style.display='inline-block'; pill.textContent=`${items?.length||0} result${(items?.length||0)>1?'s':''}`;
  if(!items || !items.length){ show(box,false); return; }
  for(const it of items){
    const name=it.customer_name||it.name||'(no name)';
    const loc=(it.locations&&it.locations[0])||{};
    const city=loc.city||it.city||''; const state=(loc.state_prov||it.state||'');
    const addr=[loc.street_1||loc.address, loc.postal_code||loc.zip].filter(Boolean).join(', ');
    const li=document.createElement('li'); li.className='item';
    li.innerHTML=`
      <div>
        <div style="font-weight:700">${name}</div>
        <div class="muted">ID: ${it.id||'N/A'} — ${city} ${state}</div>
        ${addr?`<div class="muted">${addr}</div>`:''}
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn ghost" data-use="${it.id}">Use this customer</button>
      </div>`;
    ul.appendChild(li);
  }
  show(box,true);
  ul.querySelectorAll('button[data-use]').forEach(btn=>{
    btn.onclick=async ()=>{
      const id=btn.getAttribute('data-use');
      startLoading();
      try{
        const data=await API.getCustomer(id);
        // Prefill S1
        $('#customer_id').value=data.id||'';
        $('#customer_name').value=data.customer_name||data.name||'';
        const loc=(data.locations&&data.locations[0])||{};
        $('#location_name').value=loc.nickname||$('#customer_name').value||'';
        $('#street_1').value=loc.street_1||'';
        $('#city').value=loc.city||'';
        $('#state').value=loc.state_prov||'';
        $('#zip').value=loc.postal_code||'';
        const c=(data.contacts&&data.contacts[0])||{};
        $('#contact_name').value=[c.fname,c.lname].filter(Boolean).join(' ')||'';
        if(c.emails&&c.emails[0]?.email) $('#contact_email').value=c.emails[0].email;
        if(c.phones&&c.phones[0]?.phone) $('#contact_phone').value=c.phones[0].phone;
        // Jump to next step
        jobStepper.setActive(2);
        window.scrollTo({top: document.getElementById('panelExisting').offsetTop, behavior:'smooth'});
      }catch(e){ alert('Prefill error: '+(e.message||e)); }
      finally{ endLoading(); }
    };
  });
}
async function doSearch(){
  const q=$('#q').value.trim(); if(!q) return;
  $('#searchErr').style.display='none'; startLoading();
  try{
    const items=await API.search(q);
    renderResults(items);
    if(!items.length){ $('#searchErr').textContent='No customer found.'; $('#searchErr').style.display='block'; }
  }catch(err){
    $('#searchErr').textContent=err.message||'Search failed'; $('#searchErr').style.display='block';
  }finally{ endLoading(); }
}
const debounce=(fn,ms=350)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms)}}
$('#btnSearch').onclick=doSearch;
$('#q').addEventListener('input',debounce(()=>{ if($('#q').value.trim().length>=3) doSearch(); },400));
$('#q').addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); doSearch(); } });

/* ====== Customer wizard review fill ====== */
function refreshCustomerReview(){
  const bn=$('#nc_name').value.trim();
  const cn=$('#nc_contact_name').value.trim();
  const ce=$('#nc_contact_email').value.trim();
  const cp=$('#nc_contact_phone').value.trim();
  const ln=$('#loc_name').value.trim(), st=$('#loc_street').value.trim(), ci=$('#loc_city').value.trim(), sta=$('#loc_state').value.trim(), zp=$('#loc_zip').value.trim();
  $('#rev_name').textContent = bn || '—';
  $('#rev_contact').textContent = [cn, ce||'', cp||''].filter(Boolean).join(' • ') || '—';
  $('#rev_loc').textContent = [ln, st, `${ci} ${sta} ${zp}`.trim()].filter(Boolean).join(' — ') || '—';
}
['#nc_name','#nc_contact_name','#nc_contact_email','#nc_contact_phone','#loc_name','#loc_street','#loc_city','#loc_state','#loc_zip']
  .forEach(sel=>{document.addEventListener('input',(e)=>{ if(e.target.matches(sel)) refreshCustomerReview(); });});

/* ====== Create new customer ====== */
$('#btnCreateCustomer').onclick=async ()=>{
  $('#custErr').style.display='none';
  const payload={
    customer_name: $('#nc_name').value.trim(),
    contact: { name: $('#nc_contact_name').value.trim(), email: $('#nc_contact_email').value.trim(), phone: $('#nc_contact_phone').value.trim() },
    service_location: { name: $('#loc_name').value.trim(), address: $('#loc_street').value.trim(), city: $('#loc_city').value.trim(), state: $('#loc_state').value.trim(), zip: $('#loc_zip').value.trim() }
  };
  if(!payload.customer_name || !payload.contact.name || !payload.contact.email || !payload.service_location.name || !payload.service_location.address){
    $('#custErr').textContent='Please fill required fields.'; $('#custErr').style.display='block'; return;
  }
  startLoading();
  try{
    const res=await API.createCustomer(payload);
    // Prefill job tab
    $('#customer_name').value = res.customer_name || payload.customer_name;
    $('#customer_id').value   = res.id || res.customer_id || '';
    const loc=(res.locations && res.locations[0]) || payload.service_location || {};
    $('#location_name').value = loc.nickname || loc.name || '';
    $('#street_1').value      = loc.street_1 || loc.address || '';
    $('#city').value          = loc.city || '';
    $('#state').value         = loc.state_prov || loc.state || '';
    $('#zip').value           = loc.postal_code || loc.zip || '';

    // Customer modal
    $('#cm_customer_name').textContent = $('#customer_name').value || '—';
    $('#cm_customer_id').textContent = $('#customer_id').value || '—';
    $('#cm_location').textContent = [$('#location_name').value,$('#street_1').value,`${$('#city').value} ${$('#state').value} ${$('#zip').value}`.trim()].filter(Boolean).join(' — ');
    $('#custModal').classList.add('show');
  }catch(err){
    $('#custErr').textContent = err.message || 'Create customer failed'; $('#custErr').style.display='block';
  }finally{ endLoading(); }
};

/* ====== Create job ====== */
function collectJobPayload(){
  return {
    customer_id: $('#customer_id').value.trim() || null,
    customer_name: $('#customer_name').value.trim(),
    service_location: {
      name: $('#location_name').value.trim(),
      address: $('#street_1').value.trim() || null,
      city: $('#city').value.trim() || null,
      state: $('#state').value.trim() || null,
      zip: $('#zip').value.trim() || null
    },
    category: $('#category').value,
    priority: $('#priority').value || 'Normal',
    problem_details: $('#description').value.trim(),
    contact: {
      name: $('#contact_name').value.trim() || null,
      phone: $('#contact_phone').value.trim() || null,
      email: $('#contact_email').value.trim() || null
    },
    status: $('#status').value || null
  };
}
function setBadge(status){
  const b=$('#emailBadge'); b.textContent = `Email: ${status||'unknown'}`;
  b.classList.remove('ok','warn'); if(status==='sent') b.classList.add('ok'); else b.classList.add('warn');
}
function fillJobModal({customer_name, customer_id, job_id, job_number, job_api_url, links={}, email_status}){
  $('#kv_customer_name').textContent=customer_name||'N/A';
  $('#kv_customer_id').textContent=customer_id||'N/A';
  $('#kv_job_id').textContent=job_id||'N/A';
  $('#kv_job_number').textContent=job_number||'N/A';
  $('#kv_job_url').textContent=job_api_url||'N/A';
  setBadge(email_status);
  const list=$('#linkList'); list.innerHTML='';
  const arr=[];
  if(links.docx) arr.push({href:links.docx,label:'Download DOCX'});
  if(links.json) arr.push({href:links.json,label:'View JSON'});
  for(const it of arr){ const a=document.createElement('a'); a.href=it.href; a.target='_blank'; a.rel='noopener'; a.textContent=it.label; list.appendChild(a); }
  $$('.copy').forEach(btn=>{
    btn.onclick=()=>{ const sel=btn.getAttribute('data-copy'); const t=document.querySelector(sel)?.textContent||''; navigator.clipboard.writeText(t).then(()=>{btn.textContent='Copied'; setTimeout(()=>btn.textContent='Copy',1200);}); };
  });
}
$('#btnCreate').onclick=async ()=>{
  $('#formErr').style.display='none';
  const p=collectJobPayload();
  if(!p.customer_name || !p.service_location?.name || !p.problem_details){
    $('#formErr').textContent='Please fill Customer Name, Service Location and Description.'; $('#formErr').style.display='block'; return;
  }
  const btn=$('#btnCreate'); btn.disabled=true; btn.textContent='Creating…'; startLoading();
  try{
    const res=await API.createJob(p);
    fillJobModal({
      customer_name: p.customer_name,
      customer_id: p.customer_id || 'N/A',
      job_id: res.job_id || (res.service_fusion && res.service_fusion.id) || null,
      job_number: res.job_number || (res.service_fusion && res.service_fusion.number) || null,
      job_api_url: res.job_api_url || (res.service_fusion && res.service_fusion.id ? `https://api.servicefusion.com/v1/jobs/${res.service_fusion.id}` : null),
      links: res.links || {},
      email_status: res.email_status || 'unknown',
    });
    $('#resultModal').classList.add('show');
  }catch(err){
    $('#formErr').textContent = err.message || 'Create job failed'; $('#formErr').style.display='block';
  }finally{
    btn.disabled=false; btn.textContent='Create Job'; endLoading();
  }
};

/* ====== Close modals => refresh page ====== */
function reloadSoon(){ setTimeout(()=>window.location.reload(), 120); }
$('#closeModal').onclick=()=>{ $('#resultModal').classList.remove('show'); reloadSoon(); };
$('#custCloseModal').onclick=()=>{ $('#custModal').classList.remove('show'); reloadSoon(); };
$('#custGoToJob').onclick=()=>{ $('#custModal').classList.remove('show'); showExisting(); jobStepper.setActive(2); window.scrollTo({top: document.getElementById('panelExisting').offsetTop, behavior:'smooth'}); };

/* ====== Directory logic ====== */
function renderDirList(items){
  const box=$('#dirList'); box.innerHTML='';
  $('#dirCount').textContent = `${items?.length||0} result${(items?.length||0)>1?'s':''}`;
  if(!items?.length){ box.innerHTML='<div class="dir-item"><div>No customer found.</div></div>'; return; }
  for(const it of items){
    const name=it.customer_name||it.name||'(no name)';
    const loc=(it.locations&&it.locations[0])||{};
    const city=loc.city||''; const state=loc.state_prov||'';
    const addr=[loc.street_1, loc.postal_code].filter(Boolean).join(', ');
    const row=document.createElement('div'); row.className='dir-item'; row.setAttribute('role','option'); row.tabIndex=0;
    row.innerHTML = `
      <div style="flex:1">
        <div class="dir-title">${name}</div>
        <div class="dir-sub">ID: ${it.id||'N/A'} • ${city} ${state}${addr?(' • '+addr):''}</div>
      </div>
      <div><button class="btn ghost" data-open="${it.id}">Open</button></div>`;
    box.appendChild(row);
  }
  box.querySelectorAll('[data-open]').forEach(btn=>{
    btn.onclick=()=> loadCustomerDetail(btn.getAttribute('data-open'));
  });
}
async function dirSearch(q){
  startLoading();
  try{ renderDirList(await API.search(q)); }catch{ renderDirList([]); }finally{ endLoading(); }
}
async function loadCustomerDetail(id){
  startLoading();
  try{
    const d = await API.getCustomer(id);
    // Fill the right detail pane
    const contacts=(d.contacts||[]).map(c=>{
      const nm=[c.fname,c.lname].filter(Boolean).join(' ')||'(no name)';
      const em=(c.emails&&c.emails[0]?.email)||'';
      const ph=(c.phones&&c.phones[0]?.phone)||'';
      return `<li>${nm}${em?' • '+em:''}${ph?' • '+ph:''}</li>`;
    }).join('') || '<li class="dir-sub">No contacts</li>';

    const locs=(d.locations||[]).map(l=>{
      const line=[l.nickname||'', l.street_1||'', [l.city||'', l.state_prov||'', l.postal_code||''].join(' ').trim()].filter(Boolean).join(' — ');
      return `<li>${line}</li>`;
    }).join('') || '<li class="dir-sub">No locations</li>';

    $('#dirDetail').innerHTML = `
      <h3>${d.customer_name||d.name||'(no name)'} <span class="pill" style="margin-left:6px">ID: ${d.id||'N/A'}</span></h3>
      <div class="block">
        <strong>Primary Contact & Emails</strong>
        <ul class="klist">${contacts}</ul>
      </div>
      <div class="block">
        <strong>Locations</strong>
        <ul class="klist">${locs}</ul>
      </div>
      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:10px">
        <button class="btn ghost" id="useCustomerBtn">Create Job for this Customer</button>
      </div>
    `;

    // Wire "Use" -> prefills job and switch tab
    $('#useCustomerBtn').onclick = ()=>{
      const loc=(d.locations&&d.locations[0])||{};
      $('#customer_id').value=d.id||'';
      $('#customer_name').value=d.customer_name||d.name||'';
      $('#location_name').value=loc.nickname||$('#customer_name').value||'';
      $('#street_1').value=loc.street_1||'';
      $('#city').value=loc.city||'';
      $('#state').value=loc.state_prov||'';
      $('#zip').value=loc.postal_code||'';
      const c=(d.contacts&&d.contacts[0])||{};
      $('#contact_name').value=[c.fname,c.lname].filter(Boolean).join(' ')||'';
      if(c.emails&&c.emails[0]?.email) $('#contact_email').value=c.emails[0].email;
      if(c.phones&&c.phones[0]?.phone) $('#contact_phone').value=c.phones[0].phone;

      showExisting();
      jobStepper.setActive(2);
      window.scrollTo({top: document.getElementById('panelExisting').offsetTop, behavior:'smooth'});
    };
  }catch(e){
    $('#dirDetail').innerHTML = `<div class="err">Failed to load details: ${e.message||e}</div>`;
  }finally{ endLoading(); }
}

/* Boot the directory with a broad query ('a') */
async function bootDirectory(){ await dirSearch('a'); }
$('#dirSearchBtn').onclick=()=> dirSearch(($('#dirQ').value||'a').trim() || 'a');
$('#dirQ').addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); $('#dirSearchBtn').click(); }});

/* ====== Init ====== */
function refreshCustomerReviewInit(){ refreshCustomerReview(); }
refreshCustomerReviewInit();
bootDirectory();
</script>
</body>
</html>
